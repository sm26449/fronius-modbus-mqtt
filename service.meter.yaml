name: fronius_meter
description: "Fronius Smart Meter to MQTT/InfluxDB Bridge via Modbus TCP"

# Dependencies with variable mappings
dependencies:
  - name: mosquitto
    variables:
      FRONIUS_MTR_MQTT_BROKER: "${HOST}"
      FRONIUS_MTR_MQTT_PORT: "${PORT}"
      MOSQUITTO_SERVICE: "${SERVICE_NAME}"
    credentials:
      FRONIUS_MTR_MQTT_USERNAME: "MQTT_USERNAME"
      FRONIUS_MTR_MQTT_PASSWORD: "MQTT_PASSWORD"
  - name: influxdb
    variables:
      FRONIUS_MTR_INFLUXDB_URL: "http://${HOST}:${PORT}"
      INFLUXDB_SERVICE: "${SERVICE_NAME}"
    credentials:
      FRONIUS_MTR_INFLUXDB_TOKEN: "DOCKER_INFLUXDB_INIT_ADMIN_TOKEN"
      FRONIUS_MTR_INFLUXDB_ORG: "DOCKER_INFLUXDB_INIT_ORG"

variables:
  # Modbus settings
  FRONIUS_MTR_MODBUS_HOST:
    default: "192.168.1.100"
    description: "Fronius DataManager IP address"
    prompt: true
  FRONIUS_MTR_MODBUS_PORT:
    default: "502"
    description: "Modbus TCP port"
  FRONIUS_MTR_MODBUS_TIMEOUT:
    default: "3"
    description: "Connection timeout in seconds"

  # Device IDs
  FRONIUS_MTR_METER_IDS:
    default: "240"
    description: "Smart Meter Modbus ID"
    prompt: true

  # MQTT settings
  FRONIUS_MTR_MQTT_ENABLED:
    default: "true"
    description: "Enable MQTT publishing"
  FRONIUS_MTR_MQTT_BROKER:
    default: "mosquitto"
    description: "MQTT broker address (container name or IP)"
    prompt: true
  FRONIUS_MTR_MQTT_PORT:
    default: "1883"
    description: "MQTT broker port"
    prompt: true
  FRONIUS_MTR_MQTT_USERNAME:
    default: ""
    description: "MQTT username (leave empty if not required)"
    prompt: true
  FRONIUS_MTR_MQTT_PASSWORD:
    default: ""
    description: "MQTT password"
    prompt: true
  FRONIUS_MTR_MQTT_PREFIX:
    default: "fronius"
    description: "MQTT topic prefix"

  # InfluxDB settings
  FRONIUS_MTR_INFLUXDB_ENABLED:
    default: "false"
    description: "Enable InfluxDB integration"
    prompt: true
  FRONIUS_MTR_INFLUXDB_URL:
    default: "http://influxdb:8086"
    description: "InfluxDB URL (container name or IP)"
    prompt: true
  FRONIUS_MTR_INFLUXDB_TOKEN:
    default: ""
    description: "InfluxDB API token"
    prompt: true
  FRONIUS_MTR_INFLUXDB_ORG:
    default: "homelab"
    description: "InfluxDB organization"
    prompt: true
  FRONIUS_MTR_INFLUXDB_BUCKET:
    default: "fronius"
    description: "InfluxDB bucket"
    prompt: true

  # General settings
  FRONIUS_MTR_LOG_LEVEL:
    default: "INFO"
    description: "Log level: DEBUG, INFO, WARNING, ERROR"

  # Home Assistant integration
  FRONIUS_MTR_HA_DISCOVERY_ENABLED:
    default: "false"
    description: "Enable Home Assistant MQTT autodiscovery"
    prompt: true

  # Service dependencies (for depends_on)
  MOSQUITTO_SERVICE:
    default: "mosquitto"
    description: "Mosquitto service name"
  INFLUXDB_SERVICE:
    default: "influxdb"
    description: "InfluxDB service name"

# Copy config files (same folder now)
copy_files:
  - src: config/registers.json
    dest: config/registers.json
  - src: config/FroniusEventFlags.json
    dest: config/FroniusEventFlags.json

# Hooks for pre/post deployment actions
hooks:
  pre_deploy:
    - "echo 'Preparing Fronius Meter service...'"
    - "mkdir -p ${SERVICE_DATA}/data ${SERVICE_DATA}/logs"
  post_deploy:
    - "echo 'Fronius Meter service deployed successfully'"
    # Create InfluxDB bucket in stack influxdb container (if exists)
    - "docker exec ${STACK}-influxdb influx bucket create -n '${FRONIUS_MTR_INFLUXDB_BUCKET}' -o '${FRONIUS_MTR_INFLUXDB_ORG}' 2>/dev/null && echo 'âœ“ InfluxDB bucket ${FRONIUS_MTR_INFLUXDB_BUCKET} created' || true"
    - "docker logs ${CONTAINER_NAME} --tail 5 2>/dev/null || true"

compose: |
  ${SERVICE_NAME}:
    build:
      context: .
      dockerfile: Dockerfile
    image: fronius-modbus-mqtt:latest
    container_name: ${SERVICE_NAME}
    restart: unless-stopped
    depends_on:
      ${MOSQUITTO_SERVICE}:
        condition: service_started
      ${INFLUXDB_SERVICE}:
        condition: service_healthy
    command: ["python", "fronius_modbus_mqtt.py", "-d", "meter"]
    environment:
      - TZ=${TZ}
      - MODBUS_HOST=${FRONIUS_MTR_MODBUS_HOST}
      - MODBUS_PORT=${FRONIUS_MTR_MODBUS_PORT}
      - MODBUS_TIMEOUT=${FRONIUS_MTR_MODBUS_TIMEOUT}
      - INVERTER_IDS=
      - METER_IDS=${FRONIUS_MTR_METER_IDS}
      - MQTT_ENABLED=${FRONIUS_MTR_MQTT_ENABLED}
      - MQTT_BROKER=${FRONIUS_MTR_MQTT_BROKER}
      - MQTT_PORT=${FRONIUS_MTR_MQTT_PORT}
      - MQTT_USERNAME=${FRONIUS_MTR_MQTT_USERNAME}
      - MQTT_PASSWORD=${FRONIUS_MTR_MQTT_PASSWORD}
      - MQTT_PREFIX=${FRONIUS_MTR_MQTT_PREFIX}
      - INFLUXDB_ENABLED=${FRONIUS_MTR_INFLUXDB_ENABLED}
      - INFLUXDB_URL=${FRONIUS_MTR_INFLUXDB_URL}
      - INFLUXDB_TOKEN=${FRONIUS_MTR_INFLUXDB_TOKEN}
      - INFLUXDB_ORG=${FRONIUS_MTR_INFLUXDB_ORG}
      - INFLUXDB_BUCKET=${FRONIUS_MTR_INFLUXDB_BUCKET}
      - LOG_LEVEL=${FRONIUS_MTR_LOG_LEVEL}
      - PING_CHECK_ENABLED=false
      - HA_DISCOVERY_ENABLED=${FRONIUS_MTR_HA_DISCOVERY_ENABLED}
    volumes:
      - ${DOCKER_ROOT}/${SERVICE_NAME}/config:/app/config
      - ${DOCKER_ROOT}/${SERVICE_NAME}/data:/app/data
      - ${DOCKER_ROOT}/${SERVICE_NAME}/logs:/app/logs
    healthcheck:
      test: ["CMD", "python", "/app/healthcheck.py"]
      interval: 60s
      timeout: 10s
      start_period: 60s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
